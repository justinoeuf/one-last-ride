<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Registration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #f5f5f5;
            color: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding-top: 60px;
        }

        h1 {
            font-size: 42px;
            font-weight: 400;
            text-align: center;
            margin-bottom: 60px;
            color: #000000;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cursor {
            display: inline-block;
            width: 3px;
            background-color: #000;
            margin-left: 2px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        .form-group {
            margin-bottom: 24px;
        }

        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            border: none;
            border-bottom: 2px solid #000;
            border-radius: 0;
            background: transparent;
            color: #333;
            appearance: none;
            cursor: pointer;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        input[type="text"] {
            display: none;
        }

        input[type="text"].visible {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-group label {
            margin: 0;
            font-size: 13px;
            color: #000000;
            cursor: pointer;
            line-height: 1.4;
        }

        .instruction-text {
            font-size: 16px;
            color: #000000;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        button {
            width: auto;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            background-color: #000000;
            color: #ffffff;
            border: none;
            border-radius: 0;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #333333;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        /* Alias Section */
        .alias-section {
            margin-top: 80px;
            padding-top: 40px;
            text-align: center;
        }

        .business-card {
            background: #ffffff;
            border: 2px solid #000;
            padding: 40px 30px;
            margin: 0 auto 30px;
            max-width: 320px;
            box-shadow: 4px 4px 0px #ccc;
        }

        .alias-name {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #000;
        }

        .pronunciation {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .greeting-text {
            font-size: 16px;
            color: #000;
            line-height: 1.6;
            margin-bottom: 32px;
            text-align: left;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .greeting-text strong {
            font-weight: 700;
        }

        .greeting-text em {
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 14px;
            color: #666;
        }

        .error {
            background: #ffebee;
            border: 1px solid #c62828;
            padding: 16px;
            margin: 20px 0;
            border-radius: 4px;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="helloText">Hello.<span class="cursor"></span></h1>
        
        <div class="loading" id="loadingMessage">Loading names...</div>
        
        <form id="registrationForm" class="hidden">
            <div class="form-group">
                <select id="nameSelect">
                    <option value="" disabled selected>Partiful name</option>
                </select>
                <input type="text" id="newNameInput" placeholder="Enter your name">
            </div>

            <div class="checkbox-group hidden" id="gameCheckboxGroup">
                <input type="checkbox" id="noGameCheckbox">
                <label for="noGameCheckbox">I won't be able to participate in the party game. (It's going to start around 10:30pm)</label>
            </div>

            <p class="instruction-text hidden" id="instructionText">Each guest will be given an Alias for the evening, click Continue below to generate yours.</p>

            <button type="submit" id="submitBtn" disabled>Continue</button>
        </form>

        <!-- Alias Section -->
        <div class="alias-section hidden" id="aliasSection">
            <div class="business-card">
                <div class="alias-name" id="aliasDisplay"></div>
                <div class="pronunciation" id="pronunciationDisplay"></div>
            </div>

            <p class="greeting-text" id="greetingText"></p>

            <button id="finishBtn">Finish</button>
        </div>
    </div>

    <script>
        // API Configuration
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwyqSvaqzrdWqu4tI1db4EhC17sOAAb64Y92O0TGR9l3L8oh8ATwUzgmoh64e1NMuGXkw/exec';

        // DOM Elements
        const helloText = document.getElementById('helloText');
        const loadingMessage = document.getElementById('loadingMessage');
        const registrationForm = document.getElementById('registrationForm');
        const nameSelect = document.getElementById('nameSelect');
        const newNameInput = document.getElementById('newNameInput');
        const gameCheckboxGroup = document.getElementById('gameCheckboxGroup');
        const instructionText = document.getElementById('instructionText');
        const noGameCheckbox = document.getElementById('noGameCheckbox');
        const submitBtn = document.getElementById('submitBtn');
        const aliasSection = document.getElementById('aliasSection');
        const aliasDisplay = document.getElementById('aliasDisplay');
        const pronunciationDisplay = document.getElementById('pronunciationDisplay');
        const greetingText = document.getElementById('greetingText');
        const finishBtn = document.getElementById('finishBtn');

        let selectedName = '';
        let isAddingNew = false;
        let participantData = [];

        // Typing animation for "Hello" in different languages
        const greetings = [
            'Hello.',
            'Hola.',
            'Bonjour.',
            'Ciao.',
            'Hallo.',
            'Olá.',
            '你好.',
            'こんにちは.',
            '안녕하세요.',
            'Привет.',
            'مرحبا.',
            'Namaste.'
        ];
        
        let currentGreetingIndex = 0;
        let isDeleting = false;
        let currentText = '';
        let charIndex = 0;

        function typeGreeting() {
            const fullText = greetings[currentGreetingIndex];
            
            if (!isDeleting) {
                // Typing
                currentText = fullText.substring(0, charIndex + 1);
                charIndex++;
                
                if (charIndex === fullText.length) {
                    // Pause at end of word
                    setTimeout(() => {
                        isDeleting = true;
                        typeGreeting();
                    }, 2000);
                    return;
                }
            } else {
                // Deleting
                currentText = fullText.substring(0, charIndex - 1);
                charIndex--;
                
                if (charIndex === 0) {
                    isDeleting = false;
                    currentGreetingIndex = (currentGreetingIndex + 1) % greetings.length;
                }
            }
            
            helloText.innerHTML = currentText + '<span class="cursor"></span>';
            
            const typingSpeed = isDeleting ? 50 : 100;
            setTimeout(typeGreeting, typingSpeed);
        }
        
        // Start typing animation
        setTimeout(typeGreeting, 500);

        // Load participant names from Google Sheets via Apps Script
        async function loadParticipants() {
            try {
                const url = `${SCRIPT_URL}?action=getParticipants`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.participants || data.participants.length === 0) {
                    throw new Error('No participants found');
                }

                // Store participant data
                participantData = data.participants;

                // Sort names alphabetically
                participantData.sort((a, b) => a.name.localeCompare(b.name));

                // Populate dropdown
                participantData.forEach(participant => {
                    if (participant.name) {
                        const option = document.createElement('option');
                        option.value = participant.name;
                        option.textContent = participant.name;
                        nameSelect.appendChild(option);
                    }
                });

                // Add "Add new" option
                const addNewOption = document.createElement('option');
                addNewOption.value = 'add-new';
                addNewOption.textContent = '+ Add my name';
                nameSelect.appendChild(addNewOption);

                // Show form
                loadingMessage.classList.add('hidden');
                registrationForm.classList.remove('hidden');

            } catch (error) {
                console.error('Error loading participants:', error);
                loadingMessage.innerHTML = '<div class="error">Error loading names. Please refresh the page.</div>';
            }
        }

        // Update participant status via Apps Script
        async function updateParticipantStatus(name, noGameFlag, isNew) {
            try {
                let url;
                if (isNew) {
                    url = `${SCRIPT_URL}?action=addNewParticipant&nameId=${encodeURIComponent(name)}&noGameFlag=${noGameFlag}`;
                } else {
                    url = `${SCRIPT_URL}?action=registerParticipant&nameId=${encodeURIComponent(name)}&noGameFlag=${noGameFlag}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error updating participant:', data.error);
                    return null;
                }
                
                return data;

            } catch (error) {
                console.error('Error updating participant:', error);
                return null;
            }
        }

        // Handle name selection
        nameSelect.addEventListener('change', function() {
            if (this.value === 'add-new') {
                isAddingNew = true;
                newNameInput.classList.add('visible');
                newNameInput.focus();
                gameCheckboxGroup.classList.add('hidden');
                instructionText.classList.add('hidden');
                submitBtn.disabled = true;
            } else {
                isAddingNew = false;
                selectedName = this.value;
                newNameInput.classList.remove('visible');
                newNameInput.value = '';
                gameCheckboxGroup.classList.remove('hidden');
                instructionText.classList.remove('hidden');
                submitBtn.disabled = false;
            }
        });

        // Handle new name input
        newNameInput.addEventListener('input', function() {
            selectedName = this.value.trim();
            if (selectedName) {
                gameCheckboxGroup.classList.remove('hidden');
                instructionText.classList.remove('hidden');
                submitBtn.disabled = false;
            } else {
                gameCheckboxGroup.classList.add('hidden');
                instructionText.classList.add('hidden');
                submitBtn.disabled = true;
            }
        });
        
        // Prevent form submission when pressing Enter in the text input
        newNameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur(); // Close mobile keyboard
            }
        });

        // Handle form submission
        registrationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const noGameFlag = noGameCheckbox.checked ? 1 : '';
            
            // Store in localStorage
            localStorage.setItem('partyName', selectedName);
            localStorage.setItem('noGameFlag', noGameFlag);
            localStorage.setItem('isNewUser', isAddingNew ? 'true' : 'false');
            
            // Update Google Sheets via Apps Script
            const result = await updateParticipantStatus(selectedName, noGameFlag, isAddingNew);
            
            // Get alias and pronunciation
            let alias = '';
            let pronunciation = '';
            
            if (result && result.alias) {
                alias = result.alias;
                pronunciation = result.pronunciation || '';
                localStorage.setItem('partyAlias', alias);
            } else if (!isAddingNew) {
                // Fallback: get from cached participant data
                const participant = participantData.find(p => p.name === selectedName);
                if (participant) {
                    alias = participant.alias;
                    pronunciation = participant.pronunciation || '';
                    localStorage.setItem('partyAlias', alias);
                }
            } else {
                // New user
                alias = 'TBD';
                pronunciation = 'To be assigned';
            }
            
            // Display alias
            aliasDisplay.textContent = alias;
            pronunciationDisplay.textContent = pronunciation;
            greetingText.innerHTML = `Nice to meet you <strong>${alias}</strong>! That's all for now. Make sure you pick up your name when you arrive for the party. If you are staying for the game, there will also be a wallet under your name.<br><br>Click finish to go to the main page, where the game instructions will be when the game starts. Also, if you want any of my stuff, you'll find it there too. —<em>Justin</em>.`;
            
            // Show alias section and scroll
            aliasSection.classList.remove('hidden');
            setTimeout(() => {
                aliasSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        });

        // Handle finish button
        finishBtn.addEventListener('click', function() {
            window.location.href = 'home.html';
        });

        // Load participants on page load
        loadParticipants();
    </script>
</body>
</html>
