<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #f5f5f5;
            color: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        .home-link {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 24px;
            height: 24px;
            text-decoration: none;
            cursor: pointer;
        }

        .home-link:hover {
            opacity: 0.7;
        }

        .home-icon {
            width: 24px;
            height: 24px;
            fill: #000;
        }

        .user-greeting {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 13px;
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .user-greeting:hover {
            text-decoration: underline;
        }

        .container {
            max-width: 1000px;
            margin: 80px auto 0;
        }

        h1 {
            font-size: 36px;
            font-weight: 400;
            text-align: center;
            margin-bottom: 16px;
        }

        .subtitle {
            font-size: 13px;
            text-align: center;
            margin-bottom: 40px;
            line-height: 1.5;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-size: 14px;
            font-weight: 700;
        }

        select {
            padding: 8px 12px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            border: 2px solid #000;
            border-radius: 0;
            background: #fff;
            cursor: pointer;
        }

        select.active {
            background: #000;
            color: #fff;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .items-grid {
                grid-template-columns: 1fr;
            }
        }

        .item-card {
            cursor: pointer;
            text-decoration: none;
            color: #000;
            display: block;
        }

        .item-card.claimed {
            opacity: 0.5;
        }

        .item-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: #ddd;
        }

        .item-info {
            padding: 12px 0;
        }

        .item-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .item-details {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }

        .item-price {
            font-size: 16px;
            font-weight: 700;
            margin-top: 8px;
        }

        .item-claimed {
            color: #c62828;
            font-size: 13px;
            font-weight: 700;
            margin-top: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 16px;
            color: #666;
        }
    </style>
</head>
<body>
    <a href="home.html" class="home-link">
        <svg class="home-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
    </a>

    <a href="profile.html" class="user-greeting" id="userGreeting">
        <span class="loading">Loading...</span>
    </a>

    <div class="container">
        <h1>Please take my stuff</h1>
        <p class="subtitle">Most items are FREE unless otherwise noted. CLAIM items you can take home on or before January 17th. Items marked as INTERESTED will be first come first served up until February 3rd.</p>

        <div class="controls">
            <div class="control-group">
                <label>Filter by:</label>
                <select id="filterCategory">
                    <option value="">All Categories</option>
                    <option value="sporting">Sporting</option>
                    <option value="clothes">Clothes</option>
                    <option value="accessories">Accessories</option>
                    <option value="books">Books</option>
                    <option value="furniture">Furniture</option>
                    <option value="cookware">Cookware</option>
                    <option value="misc">Misc</option>
                </select>
            </div>

            <div class="control-group">
                <select id="filterCondition">
                    <option value="">All Conditions</option>
                    <option value="Brand new">Brand New</option>
                    <option value="Like new">Like New</option>
                    <option value="Good">Good</option>
                    <option value="Acceptable">Acceptable</option>
                </select>
            </div>

            <div class="control-group">
                <select id="filterMyItems">
                    <option value="">All Items</option>
                    <option value="my-items">My Items</option>
                </select>
            </div>

            <div class="control-group">
                <label>Sort by:</label>
                <select id="sortBy">
                    <option value="">Default</option>
                    <option value="price">Price</option>
                    <option value="condition">Condition</option>
                </select>
            </div>
        </div>

        <div class="loading" id="loadingMessage">Loading items...</div>
        <div class="items-grid" id="itemsGrid"></div>
        <div class="empty-state" id="emptyState" style="display: none;"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxPuryFhmcvkUD3rbQdq-cG6aF1SWKWedZ4lh7l6mrlKEDPBaCyG_h424xynSSTKr7BhA/exec';
        
        // Get user info
        const userAlias = localStorage.getItem('partyAlias') || localStorage.getItem('partyName') || 'Guest';
        const userName = localStorage.getItem('partyName');
        document.getElementById('userGreeting').innerHTML = `Hi, ${userAlias}`;

        // Redirect if not logged in
        if (!userName) {
            window.location.href = 'index.html';
        }

        let allItems = [];
        const conditionOrder = ['Brand new', 'Like new', 'Good', 'Acceptable'];

        // Load items
        async function loadItems() {
            try {
                const url = `${SCRIPT_URL}?action=getShopItems`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                allItems = data.items || [];
                renderItems();
                document.getElementById('loadingMessage').style.display = 'none';

            } catch (error) {
                console.error('Error loading items:', error);
                document.getElementById('loadingMessage').innerHTML = 'Error loading items. Please refresh the page.';
            }
        }

        // Render items
        function renderItems() {
            let items = [...allItems];
            const itemsGrid = document.getElementById('itemsGrid');
            const emptyState = document.getElementById('emptyState');

            // Get filter values
            const filterCategory = document.getElementById('filterCategory').value;
            const filterCondition = document.getElementById('filterCondition').value;
            const filterMyItems = document.getElementById('filterMyItems').value;
            const sortBy = document.getElementById('sortBy').value;

            // Apply filters
            if (filterCategory) {
                items = items.filter(item => {
                    const categories = item.category ? item.category.toLowerCase().split(',').map(c => c.trim()) : [];
                    return categories.includes(filterCategory.toLowerCase());
                });
            }

            if (filterCondition) {
                items = items.filter(item => item.condition === filterCondition);
            }

            if (filterMyItems === 'my-items') {
                items = items.filter(item => {
                    const isClaimed = item.claimedBy === userName;
                    const isInterested = item.interested && item.interested.split(',').map(n => n.trim()).includes(userName);
                    return isClaimed || isInterested;
                });
            }

            // Apply sorting
            if (sortBy === 'price') {
                items.sort((a, b) => {
                    const priceA = a.price === 'FREE' ? 0 : parseFloat(a.price.toString().replace('$', ''));
                    const priceB = b.price === 'FREE' ? 0 : parseFloat(b.price.toString().replace('$', ''));
                    return priceA - priceB;
                });
            } else if (sortBy === 'condition') {
                items.sort((a, b) => {
                    const indexA = conditionOrder.indexOf(a.condition);
                    const indexB = conditionOrder.indexOf(b.condition);
                    return indexA - indexB;
                });
            }

            // Render
            if (items.length === 0) {
                itemsGrid.innerHTML = '';
                itemsGrid.style.display = 'none';
                emptyState.style.display = 'block';
                
                if (filterMyItems === 'my-items') {
                    emptyState.textContent = "You haven't taken any of my stuff yet";
                } else {
                    emptyState.textContent = "Yeah, I don't have that";
                }
                return;
            }

            itemsGrid.style.display = 'grid';
            emptyState.style.display = 'none';

            itemsGrid.innerHTML = items.map(item => {
                const isClaimed = item.status === 'Claimed';
                const priceDisplay = item.price === 'FREE' ? 'FREE' : `$${item.price}`;
                
                return `
                    <a href="item-detail.html?id=${item.itemId}" class="item-card ${isClaimed ? 'claimed' : ''}">
                        <img src="${item.imageUrl}" alt="${item.item}" class="item-image" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27200%27 height=%27200%27%3E%3Crect fill=%27%23ddd%27 width=%27200%27 height=%27200%27/%3E%3C/svg%3E'">
                        <div class="item-info">
                            <div class="item-name">${item.item}</div>
                            <div class="item-details">${item.condition}</div>
                            <div class="item-price">${priceDisplay}</div>
                            ${isClaimed ? '<div class="item-claimed">Claimed</div>' : ''}
                        </div>
                    </a>
                `;
            }).join('');
        }

        // Event listeners
        document.getElementById('filterCategory').addEventListener('change', function() {
            this.classList.toggle('active', this.value !== '');
            renderItems();
        });
        
        document.getElementById('filterCondition').addEventListener('change', function() {
            this.classList.toggle('active', this.value !== '');
            renderItems();
        });
        
        document.getElementById('filterMyItems').addEventListener('change', function() {
            this.classList.toggle('active', this.value !== '');
            renderItems();
        });
        
        document.getElementById('sortBy').addEventListener('change', renderItems);

        // Load items on page load
        loadItems();
    </script>
</body>
</html>
